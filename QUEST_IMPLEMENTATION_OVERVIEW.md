# Quest Implementation Overview

This document provides a detailed overview of the current implementation of the "Quest" system, based on a review of the backend codebase, including the database schema, API routes, and core business logic.

## 1. Database Schema

The quest system's data is structured across several related tables in the PostgreSQL database.

### 1.1. Core Tables

#### `quests`
This is the central table for all quests.

| Column | Type | Description | Required/Optional |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary key for the quest. | Required |
| `title` | `text` | The main title of the quest. | Required |
| `description` | `text` | A detailed description of the quest's purpose and narrative. | Optional |
| `big_idea` | `text` | The core learning concept or essential question the quest addresses. | Optional |
| `source` | `varchar` | The origin of the quest content (e.g., 'custom', 'Khan Academy'). | Optional (Defaults to 'custom') |
| `header_image_url` | `text` | URL for a custom header image. If null, a header from the `quest_sources` table may be used. | Optional |
| `is_v3` | `boolean` | Flag indicating if it's a V3 quest. | Optional (Defaults to `true`) |
| `is_active` | `boolean` | Determines if the quest is available for users to enroll in. | Optional (Defaults to `true`) |
| `created_by` | `uuid` | Foreign key to the `users` table for the author. | Optional |
| `created_at` | `timestamptz` | Timestamp of when the quest was created. | Required (Defaults to `now()`) |
| `metadata` | `jsonb` | A flexible field for storing additional, non-critical quest data. | Optional |

#### `quest_tasks`
Each quest is composed of multiple tasks. This table defines those tasks.

| Column | Type | Description | Required/Optional |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary key for the task. | Required |
| `quest_id` | `uuid` | Foreign key linking the task to a quest in the `quests` table. | Required |
| `title` | `text` | The title of the individual task. | Required |
| `description` | `text` | A description of what the task entails. | Optional |
| `pillar` | `USER-DEFINED` | The primary learning pillar this task belongs to (e.g., "STEM & Logic"). | Required |
| `xp_amount` | `integer` | The amount of XP awarded upon task completion. | Required |
| `order_index` | `integer` | The order in which the task should appear within the quest. | Optional (Defaults to 0) |
| `is_required` | `boolean` | If `true`, this task must be completed to finish the quest. | Optional (Defaults to `true`) |
| `school_subjects`| `ARRAY` | An array of school subjects this task relates to. | Optional |

### 1.2. User Progress & Enrollment Tables

#### `user_quests`
This table tracks the relationship between a user and a quest they have started.

| Column | Type | Description | Required/Optional |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary key for the enrollment record. | Required |
| `user_id` | `uuid` | Foreign key to the `users` table. | Required |
| `quest_id` | `uuid` | Foreign key to the `quests` table. | Required |
| `started_at` | `timestamptz` | Timestamp when the user enrolled in the quest. | Required (Defaults to `now()`) |
| `completed_at` | `timestamptz` | Timestamp when the user completed the quest. | Optional |
| `is_active` | `boolean` | `true` if the user is actively working on the quest. Set to `false` if they end it. | Optional (Defaults to `true`) |

#### `user_quest_tasks` & `quest_task_completions`
These tables (with some overlapping responsibility) track the completion of individual tasks by a user. `quest_task_completions` appears to be part of a newer, more atomic workflow.

| Column | Type | Description | Required/Optional |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary key. | Required |
| `user_id` | `uuid` | Foreign key to the `users` table. | Required |
| `quest_id` | `uuid` | Foreign key to the `quests` table. | Required |
| `task_id` / `quest_task_id` | `uuid` | Foreign key to the `quest_tasks` table. | Required |
| `evidence_content` / `evidence_text` | `text` | User-submitted text evidence. | Required |
| `evidence_url` | `text` | URL for user-submitted evidence (e.g., image, document). | Optional |
| `completed_at` | `timestamptz` | Timestamp of task completion. | Required (Defaults to `now()`) |

### 1.3. Supporting Tables

- **`quest_sources`**: Stores information about the origins of quests (e.g., 'Khan Academy') and provides a default `header_image_url`.
- **`quest_ratings`**: Stores user-submitted ratings (1-5) for quests.
- **`quest_ideas`**: A place for users to submit ideas for new quests.
- **`quest_collaborations`**: Manages requests for users to collaborate on a quest.
- **`ai_generated_quests`**: Stores quests generated by an AI, awaiting review and publication.

## 2. Quest Attributes & Validation

The `QuestValidator` class (`backend/utils/quest_validation.py`) defines a set of rules for what constitutes a high-quality quest. This is likely used during an admin/curation process.

### Required Attributes (for creation/validation):
- **`title`**: Must be between 5 and 100 characters.
- **`description`**: Must be at least 20 characters.
- **`tasks`**: A quest must have at least one task.

### Optional Attributes (for creation/validation):
- **`difficulty`**: ('beginner', 'intermediate', 'advanced'). This influences validation rules for task count and XP values.
- **`big_idea`**: A high-level learning objective.
- **Task Attributes**:
    - `title`
    - `description`
    - `pillar` (from a list of valid pillars)
    - `xp_value`
    - `evidence_type` ('text', 'image', 'video', 'document')

The validation service scores quests on:
- **Content Appropriateness**: Scans for keywords related to violence, drugs, etc.
- **Educational Value**: Scores based on the presence of action verbs (e.g., 'analyze', 'create'), diversity of task types, and clear objectives.
- **XP Balance**: Ensures XP values are consistent with the quest's stated difficulty.
- **Task Quality**: Checks that tasks have clear, actionable descriptions.

## 3. Backend API Routes

The primary API endpoints are defined in `backend/routes/quests.py` using Flask.

| Endpoint | Method | Auth | Description |
| :--- | :--- | :--- | :--- |
| `/api/quests` | `GET` | Public | Lists all active quests. Supports pagination, search, and filtering by `pillar` and `subject`. Returns user-specific enrollment status if authenticated. |
| `/api/quests/<quest_id>` | `GET` | Required | Fetches all details for a single quest, including its tasks and the current user's progress (enrollment, completed tasks, collaboration status). |
| `/api/quests/<quest_id>/enroll` | `POST` | Required (Paid Tier) | Enrolls the current user in the specified quest. Creates a new record in `user_quests`. |
| `/api/quests/<quest_id>/end` | `POST` | Required | Ends a user's active enrollment in a quest by setting `is_active` to `false` in the `user_quests` table. Progress is preserved. |
| `/api/quests/my-active` | `GET` | Required | Returns a list of all quests the user is currently and actively enrolled in. |
| `/api/quests/completed` | `GET` | Required | Returns a list of all quests the user has completed or has made progress on (at least one task submitted). |
| `/api/quests/sources` | `GET` | Public | Returns a list of all available quest sources and their associated header images. |

## 4. Core Business Logic

The `AtomicQuestService` (`backend/services/atomic_quest_service.py`) is critical for handling state changes reliably.

- **Atomic Task Completion**: The `complete_task_atomically` method ensures that a user cannot complete the same task multiple times, even with concurrent requests. It uses a `UNIQUE` constraint on `quest_task_completions` to enforce this.
- **Atomic Quest Completion**: After a task is completed, `check_and_complete_quest_atomically` is called.
    - It verifies if all `is_required = true` tasks for the quest have been completed by the user.
    - If so, it updates the `user_quests` record to set the `completed_at` timestamp. It uses optimistic locking (checking for `completed_at IS NULL`) to prevent race conditions where a quest might be marked as complete by two different processes.
- **XP & Bonus Awards**: The service also handles awarding XP for task completion and calculates a potential bonus (50% of total quest XP) if a user completes *all* tasks, including optional ones.
